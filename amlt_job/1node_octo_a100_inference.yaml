description: bitnet

target:
  service: sing
  name: msroctovc
  resource_group: gcr-singularity-octo
  # workspace_name: Workspace_NLC
  workspace_name: NLC_Workspace


environment:
  # image: hangbo/pytorch-2.23dev:xformers
  # image: hangbo/pytorch-2.23dev:xformers_s2
  image: amlt-sing/acpt-2.3.1-py3.10-cuda12.1
  setup:
  - echo "master_addr:" "$$MASTER_ADDR"
  - echo "master_port:" $$MASTER_PORT
  - echo "node_rank:" $$OMPI_COMM_WORLD_RANK



code:
  local_dir: $CONFIG_DIR/..

storage:
  lingjiejiang:
    storage_account_name: msranlpintern
    container_name: lingjiejiang
#   msranlp:
#     storage_account_name: msranlp
#     container_name: unilm
#   nlcredstone:
#     storage_account_name: nlcredstone
#     container_name: unilm
#   conversationhub:
#     storage_account_name: conversationhub
#     container_name: unilm
#   conversationhubhot:
#     storage_account_name: conversationhubhot
#     container_name: tengchaolv


search:
  job_template:
    name: PRJ-0349-A54-1_.58_-bit-LLMs-test-scaling
    # sku: 1x40G8
    sku: 40G1
    identity: managed
    # mpi: True
    # process_count_per_node: 1
    command:
    - pip install datasets
    - pip install vllm --user
    - echo $${rank}
    - python eval/reason/eval.py --model-path /mnt/lingjiejiang/math_reason/exp/1220_dpo_data/bsz64_lr2e7_e1/checkpoint-567/ --output /mnt/lingjiejiang/math_reason/exp/1220_dpo_data/bsz64_lr2e7_e1/checkpoint-567/math_500_eval 
    # --only-eval
    submit_args:
      env:
        {"SINGULARITY_MPI_ENV":"-mca pml ucx --mca btl ^vader,tcp,openib -x NCCL_SOCKET_IFNAME=bond0 -x NCCL_IB_HCA=mlx5_0,mlx5_3,mlx5_4,mlx5_5,mlx5_6,mlx5_9,mlx5_10,mlx5_11 -x NCCL_DEBUG=INFO"}
      # container_args:
      #   shm_size: 256g
    tags: [Project_Name:1.58-bit-LLMs, ProjectID:PRJ-0349-A54, Experiment:BitNet-scaling]

  type: grid
  max_trials: 500
  params:
    - name: rank
      spec: discrete
      # values: ['bitnet_glan1.5_default_template_2e5_e2_bsz128.yaml']
      # values: ['bitnet_glan1.5_default_template_5e6_e4_bsz128.yaml']
      # values: ['gemma_magpie_dpo_v0.1_2048_default_template_glan1.5_7332.yaml']
      # values: ['gemma_magpie_dpo_v0.1_2048_default_template_glan1.5_7332_dponorm.yaml', 'bitnet_glan1.5_default_template_5e6_e4_bsz128.yaml', 'gemma_magpie_dpo_v0.1_2048_default_template_glan1.5_7332.yaml']
      # values: ['gemma_magpie_dpo_v0.1_2048_default_template_glan1.5_7332_dponorm.yaml', ]
      # values: ['gemma_magpie_dpo_v0.1_2048_default_template_glan1.5_7332.yaml', 'gemma_magpie_dpo_v0.1_2048_default_template_glan1.5_7332_bsz32.yaml']
      # values: ['bitnet_magpie_dpo_v0.1_2048_default_template_glan1.5_sm_bsz32.yaml', 'bitnet_magpie_dpo_v0.1_2048_default_template_glan1.5_sm.yaml', 'bitnet_magpie_dpo_v0.1_2048_default_template_glan1.5_sm_bsz32_lr4e7.yaml', 'bitnet_magpie_dpo_v0.1_2048_default_template_glan1.5_sm_bsz128.yaml']
      values: ['gemma_tulu3_dpo_v0.1_2048_default_template_glan1.5_7332_bsz32.yaml']
      # values: ['bitnet_magpie_dpo_v0.1_2048_default_template_glan1.5_sm_bsz128.yaml']

